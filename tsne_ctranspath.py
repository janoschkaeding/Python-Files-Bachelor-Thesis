# -*- coding: utf-8 -*-
"""
Created on Thu Jul  3 11:22:23 2025

@author: Janos
"""

import h5py
import numpy as np
import os
import glob
import matplotlib.pyplot as plt
import seaborn as sns 
import re
from sklearn.manifold import TSNE
from sklearn.cluster import KMeans


#Selecting the image folders
folders = [
    r"C:/Users/Janos/Desktop/blood/BSNP_ctranspath/xiyuewang-ctranspath-7c998680-dab38abe",
    r"C:\Users\Janos\Desktop\blood\control_ctranspath\xiyuewang-ctranspath-7c998680-dab38abe",
    r"C:\Users\Janos\Desktop\blood\NP_HS_ctranspath\xiyuewang-ctranspath-7c998680-dab38abe",
    r"C:\Users\Janos\Desktop\blood\SH_ctranspath\xiyuewang-ctranspath-7c998680-dab38abe",
    r"C:\Users\Janos\Desktop\blood\extra_crenatedcells_ctranspath\xiyuewang-ctranspath-7c998680-dab38abe",
    r"C:\Users\Janos\Desktop\blood\extra_echinocyte_ctranspath\xiyuewang-ctranspath-7c998680-dab38abe",
    r"C:\Users\Janos\Desktop\blood\extra_ecocentric_ctranspath\xiyuewang-ctranspath-7c998680-dab38abe",
    r"C:\Users\Janos\Desktop\blood\extra_rouleaux_ctranspath\xiyuewang-ctranspath-7c998680-dab38abe",
    r"C:\Users\Janos\Desktop\blood\extra_schistocyte_ctranspath\xiyuewang-ctranspath-7c998680-dab38abe",
    r"C:\Users\Janos\Desktop\blood\extra_teardrop_ctranspath\xiyuewang-ctranspath-7c998680-dab38abe",
]

#Setting the number of features to read from each file
feat_len = 767

#Creating the list of h5 files and 
h5_files = []
for folder in folders:
    files = glob.glob(os.path.join(folder, "*.h5"))
    files.sort(key=lambda path: int(re.search(r'(\d+)', os.path.basename(path)).group(1)) if re.search(r'(\d+)', os.path.basename(path)) else float('inf'))
    h5_files.extend(files)

#Reading the features from the h5 files and creating and index containing all features
index_files = [np.array([], dtype=object)] * len(h5_files)
for idx, file_path in enumerate(h5_files):
    with h5py.File(file_path, 'r') as f:
        index_files[idx] = f['feats'][0:feat_len]


#Setting up the matrix containg all features of all 1139 cells, having one row in the matrix contain every feature of one cell
num_samples = min(1139, len(index_files))
d = np.zeros((num_samples, feat_len))
for i in range(num_samples):
    for s in range(feat_len):
        d[i, s] = index_files[i][0, s]


#Setting up the labels and providing the annotation   
labels=["normal","rouleaux","echinocyte","teardrop","schistocyte","crenatedcells","ecocentric"]
annodata=["normal","normal","rouleaux","echinocyte","rouleaux","echinocyte","teardrop","teardrop","echinocyte","normal","echinocyte","schistocyte","normal","schistocyte","rouleaux","teardrop","rouleaux","rouleaux","normal","normal","normal","crenatedcells","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","schistocyte","normal","normal","echinocyte","crenatedcells","schistocyte","normal","rouleaux","schistocyte","teardrop","echinocyte","rouleaux","normal","echinocyte","normal","rouleaux","echinocyte","schistocyte","echinocyte","echinocyte","teardrop","schistocyte","echinocyte","normal","schistocyte","crenatedcells","crenatedcells","normal","teardrop","echinocyte","normal","rouleaux","crenatedcells","rouleaux","teardrop","rouleaux","rouleaux","schistocyte","teardrop","schistocyte","echinocyte","echinocyte","crenatedcells","echinocyte","normal","crenatedcells","echinocyte","schistocyte","echinocyte","rouleaux","normal","rouleaux","crenatedcells","rouleaux","teardrop","rouleaux","normal","teardrop","ecocentric","normal","normal","echinocyte","echinocyte","crenatedcells","ecocentric","crenatedcells","teardrop","schistocyte","teardrop","normal","normal","echinocyte","schistocyte","echinocyte","schistocyte","crenatedcells","teardrop","rouleaux","rouleaux","rouleaux","schistocyte","normal","teardrop","schistocyte","echinocyte","rouleaux","normal","normal","rouleaux","normal","rouleaux","rouleaux","rouleaux","normal","teardrop","rouleaux","rouleaux","normal","ecocentric","teardrop","ecocentric","ecocentric","teardrop","normal","normal","normal","ecocentric","normal","normal","normal","normal","ecocentric","normal","normal","normal","ecocentric","crenatedcells","normal","normal","normal","normal","schistocyte","normal","crenatedcells","crenatedcells","teardrop","normal","teardrop","ecocentric","normal","crenatedcells","ecocentric","normal","schistocyte","normal","normal","normal","normal","normal","normal","ecocentric","schistocyte","normal","ecocentric","crenatedcells","schistocyte","normal","normal","normal","normal","normal","normal","normal","ecocentric","normal","normal","normal","normal","normal","normal","normal","normal","normal","ecocentric","normal","normal","normal","ecocentric","normal","schistocyte","normal","normal","schistocyte","normal","normal","normal","normal","ecocentric","schistocyte","schistocyte","teardrop","normal","normal","normal","schistocyte","normal","normal","normal","normal","normal","schistocyte","schistocyte","normal","normal","teardrop","schistocyte","echinocyte","normal","normal","normal","normal","normal","normal","schistocyte","normal","normal","normal","normal","normal","normal","normal","normal","normal","normal","ecocentric","schistocyte","ecocentric","normal","normal","schistocyte","normal","normal","normal","normal","normal","normal","normal","normal","normal","normal","teardrop","normal","schistocyte","teardrop","normal","ecocentric","schistocyte","normal","schistocyte","normal","schistocyte","normal","normal","normal","normal","normal","normal","teardrop","normal","normal","normal","teardrop","crenatedcells","teardrop","schistocyte","teardrop","teardrop","schistocyte","teardrop","normal","normal","ecocentric","teardrop","normal","normal","normal","schistocyte","teardrop","ecocentric","schistocyte","schistocyte","normal","ecocentric","schistocyte","schistocyte","normal","normal","teardrop","teardrop","schistocyte","normal","crenatedcells","crenatedcells","ecocentric","teardrop","crenatedcells","ecocentric","teardrop","normal","normal","schistocyte","ecocentric","normal","teardrop","normal","schistocyte","normal","crenatedcells","crenatedcells","normal","teardrop","schistocyte","crenatedcells","schistocyte","teardrop","crenatedcells","schistocyte","teardrop","normal","teardrop","normal","schistocyte","normal","schistocyte","crenatedcells","normal","crenatedcells","ecocentric","ecocentric","teardrop","schistocyte","schistocyte","normal","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","normal","schistocyte","schistocyte","ecocentric","schistocyte","normal","normal","normal","normal","normal","schistocyte","teardrop","teardrop","ecocentric","schistocyte","normal","normal","ecocentric","schistocyte","schistocyte","schistocyte","teardrop","schistocyte","schistocyte","schistocyte","normal","schistocyte","crenatedcells","normal","ecocentric","teardrop","schistocyte","schistocyte","crenatedcells","teardrop","teardrop","ecocentric","normal","crenatedcells","schistocyte","schistocyte","teardrop","teardrop","teardrop","teardrop","teardrop","schistocyte","teardrop","normal","schistocyte","schistocyte","schistocyte","schistocyte","ecocentric","teardrop","ecocentric","teardrop","ecocentric","crenatedcells","ecocentric","schistocyte","ecocentric","teardrop","schistocyte","schistocyte","crenatedcells","schistocyte","schistocyte","schistocyte","ecocentric","ecocentric","normal","ecocentric","schistocyte","crenatedcells","ecocentric","ecocentric","teardrop","schistocyte","teardrop","schistocyte","schistocyte","normal","teardrop","teardrop","schistocyte","ecocentric","schistocyte","schistocyte","schistocyte","crenatedcells","normal","crenatedcells","schistocyte","teardrop","teardrop","schistocyte","ecocentric","ecocentric","teardrop","crenatedcells","normal","ecocentric","ecocentric","normal","normal","ecocentric","normal","schistocyte","normal","schistocyte","schistocyte","teardrop","ecocentric","ecocentric","crenatedcells","normal","ecocentric","normal","ecocentric","normal","normal","normal","teardrop","ecocentric","normal","schistocyte","teardrop","ecocentric","ecocentric","ecocentric","ecocentric","crenatedcells","normal","normal","teardrop","ecocentric","ecocentric","normal","normal","normal","schistocyte","normal","normal","teardrop","schistocyte","schistocyte","teardrop","schistocyte","teardrop","normal","crenatedcells","teardrop","teardrop","normal","teardrop","crenatedcells","teardrop","teardrop","normal","normal","teardrop","teardrop","teardrop","teardrop","schistocyte","teardrop","ecocentric","ecocentric","teardrop","teardrop","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","crenatedcells","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","echinocyte","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","ecocentric","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","rouleaux","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","schistocyte","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop","teardrop"]

#Setting up the color Index for the plot
rgb_assign=[(255,0,0),(0,255,0),(0,0,255),(255,255,0),(255,0,255),(0,255,255),(100,0,100),(255,200,0),(255,100,100),(10,100,100),(100,100,10),]
rgb_colors=[(r/255,g/255,b/255) for r,g,b in rgb_assign]
custom_palette= dict(zip(labels, rgb_colors))

#Performing t-SNE and k-means
tsne = (TSNE(n_components=2, learning_rate='auto', init='random', perplexity=3))
result = tsne.fit_transform(d)
kmeans = KMeans(n_clusters=7, random_state=0)
kmeans.fit(result)

#plotting the results
sns.scatterplot( x=result[:,0], y=result[:, 1],palette=custom_palette, hue=annodata)

#Adjusting the plot and displayingthe final plot
plt.legend(
    loc='center left',
    bbox_to_anchor=(1, 0.5),
    title='Classes'
)
plt.tight_layout()
plt.subplots_adjust(right=0.75)
plt.show()
        